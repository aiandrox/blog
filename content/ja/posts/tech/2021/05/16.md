---
title: 【Rails】アソシエーションの状態を持つフォームオブジェクト
date: 2021-05-16
draft: false
tags:
  - フォームオブジェクト
  - Ruby
  - Rails
categories:
  - Ruby, Rails
image: images/logos/rails.png
series:
  - 技術関連
---

一対多のアソシエーションを持つフォームオブジェクトに苦労したので記録です。

実装のきれいさは置いておいてください。

### バージョン

- Ruby 2.7
- Rails 6.0


## フォーム

```rb
class ReviewForm
  include ActiveModel::Model
  include ActiveModel::Attributes

  attribute :answer_id, :integer
  attribute :total_grade, :string
  attribute :comment, :string
  attribute :reviewer_id, :integer
  attribute :evaluations_attributes

  validates :answer_id, presence: true
  validates :reviewer_id, presence: true
  validate :review_validity

  class << self
    def find_or_initialize_by(answer_id:)
      Review.exists?(answer_id: answer_id) ? find(answer_id) : new
    end

    def find(answer_id)
      review = Review.find_by!(answer_id: answer_id)
      evaluations_attributes = review.evaluations.map(&:attributes)
      review_attributes = review.attributes.deep_symbolize_keys.slice(
        :answer_id,
        :comment,
        :total_grade
      )
      review_attributes.store(:evaluations_attributes, evaluations_attributes)
      new(review_attributes)
    end
  end

  def initialize(params = nil)
    super(params&.deep_symbolize_keys)
  end

  def save
    return false if invalid?

    ActiveRecord::Base.transaction(joinable: false, requires_new: true) do
      build_review_and_evaluations
      review.save!
      review.fetch_total_grade!
    end
    true
  end

  def to_model
    Review.new
  end

  private

  def review_validity
    return if errors.any?
    return if review.valid?

    review.errors.messages.each do |attribute, messages|
      messages.each do |message|
        errors.add(attribute, message)
      end
    end
  end

  def build_review_and_evaluations
    review.evaluations = evaluations_array
  end

  def review_params
    {
      answer_id: answer_id,
      comment: comment,
      total_grade: total_grade,
      reviewer_id: reviewer_id,
      reviewed_at: Time.zone.now,
    }
  end

  def review
    return @review if defined?(@review)

    @review = Review.find_or_initialize_by(answer_id: answer_id)
    @review.assign_attributes(review_params)
    @review
  end

  def evaluations_array
    @evaluations_array ||=
      evaluations_attributes.map { |attributes| each_evaluation(attributes) }
  end

  def each_evaluation(attributes)
    evaluation = review.evaluations.find_or_initialize_by(
      attributes.slice(:evaluation_item_id)
    )
    evaluation.tap { |e| e.update!(attributes) }
  end
end
```
