---
title: 【Rails】Sorceryの外部認証でコールバックURLを動的に変える
date: 2021-06-12
draft: false
tags:
  - Rails
  - Sorcery
categories:
  - Ruby, Rails
image: images/logos/rails.png
series:
  - 技術関連
---

## コールバックURLを動的に変更する

こんな感じで、attr_readerを設定して`provider.callback_url`にコールバック先のURLを入れる。

```rb
class OauthsController < ApplicationController
  def oauth
    login_at(auth_params[:provider])
    # 極端なことを言うと、こんなコールバック先にもできる
    provider.callback_url = 'https://www.google.com/'
  end

  private

  attr_reader :provider
end
```

### Sorceryのコード

```rb
module Sorcery
  module Controller
    module Submodules
      module External
        module InstanceMethods
          protected

          # 一部省略

          def sorcery_login_url(provider_name, args = {})
            @provider = sorcery_get_provider provider_name
            sorcery_fixup_callback_url @provider

            return nil unless @provider.respond_to?(:login_url) && @provider.has_callback?

            @provider.state = args[:state]
            @provider.login_url(params, session)
          end

          def sorcery_fixup_callback_url(provider)
            provider.original_callback_url ||= provider.callback_url

            return unless provider.original_callback_url.present? && provider.original_callback_url[0] == '/'

            uri = URI.parse(request.url.gsub(/\?.*$/, ''))
            uri.path = ''
            uri.query = nil
            uri.scheme = 'https' if request.env['HTTP_X_FORWARDED_PROTO'] == 'https'
            host = uri.to_s
            provider.callback_url = "#{host}#{@provider.original_callback_url}"
          end

          # このメソッドをログイン時のコントローラで呼び出している
          def login_at(provider_name, args = {})
            redirect_to sorcery_login_url(provider_name, args)
          end
        end
      end
    end
  end
end
```

`external`を使うことでこのモジュールがコントローラにincludeされることになっている。
ここの30行目をオーバーライドすることで、コールバック先を変えることができる。

[sorcery/external\.rb at 5fae86fcaf836e32d29ff456ce96bcb65dda6922 · Sorcery/sorcery](https://github.com/Sorcery/sorcery/blob/5fae86fcaf836e32d29ff456ce96bcb65dda6922/lib/sorcery/controller/submodules/external.rb)


### GitHubの場合

遷移先は、外部認証側のコールバックURL設定が必要。

![image](https://user-images.githubusercontent.com/44717752/121764266-abe20900-cb7d-11eb-8de4-b101986cf2f5.png)

> CALLBACK: http://example.com/path
>
> GOOD: http://example.com/path
GOOD: http://example.com/path/subdir/other
BAD:  http://example.com/bar
BAD:  http://example.com/
BAD:  http://example.com:8080/path
BAD:  http://oauth.example.com:8080/path
BAD:  http://example.org
>
> [Authorizing OAuth Apps \- GitHub Docs](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#redirect-urls)
