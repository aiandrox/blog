---
title: GitHub Actions ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼†ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥ã¾ã§
date: 2022-07-08
draft: false
libraries:
  - mermaid
tags:
  - GitHub
  - è‡ªå‹•åŒ–
  - Heroku
categories:
  - ãã®ä»–
image: images/logos/github.png
series:
  - æŠ€è¡“é–¢é€£
---

## æµã‚Œ

- æ™®æ®µã®é–‹ç™ºã¯featureãƒ–ãƒ©ãƒ³ãƒã§è¡Œã†
- featureãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰developã«ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€developã‹ã‚‰mainã¸ã®PRãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹
  - PRã«ã¯ã€ã©ã®feature PRãŒä»Šå›ã®ãƒªãƒªãƒ¼ã‚¹ã«å«ã¾ã‚Œã‚‹ã‹ã‚’è¨˜è¼‰ã™ã‚‹
- ä¸Šè¨˜ã®developâ†’mainã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€ãã‚Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã‚‹
- ã¾ãŸã€åŒæ™‚ã«GitHub releaseãŒè¡Œã‚ã‚Œã¦ã€ã‚¿ã‚°ãŒä»˜ã‘ã‚‰ã‚Œã‚‹
  - ãƒªãƒªãƒ¼ã‚¹å†…å®¹ã‚’Slackã«é€šçŸ¥ã™ã‚‹

```mermaid
flowchart TB
  subgraph branch
    feature --> |"PR merge"| develop --> |"PR merge"| main
  end

  action["GitHub Action"] .-> |"auto created PR"| develop
  action .-> |"deploy"| heroku
  action .-> |"publish"| release[GitHub release]
  action .-> |"notification"| slack[Slack]

  subgraph release flow
    heroku
    release
    slack
  end
```

ï¼ˆè¿½è¨˜ï¼‰
å¾Œã‹ã‚‰æ°—ã¥ã„ãŸãŒã€ãƒªãƒªãƒ¼ã‚¹ã®Slacké€šçŸ¥ã«é–¢ã—ã¦ã¯[GitHubãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Slacké€šçŸ¥](https://github.com/integrations/slack)ã§ã„ã„æ°—ãŒã—ãŸã€‚


## ä½¿ç”¨ã—ãŸ GitHub Actions

### [git\-pr\-release\-action](https://github.com/bakunyo/git-pr-release-action)

ãƒªãƒªãƒ¼ã‚¹ç”¨ã® PR ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒãƒ¼ã‚¸å…ƒã¨ãƒãƒ¼ã‚¸å…ˆã¨ã®å·®åˆ†ã® PR ã®æƒ…å ±ã‚’éšæ™‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™ã€‚
[git\-pr\-release ã‚’å®Ÿè¡Œã™ã‚‹ GitHub Action ã‚’ã¤ãã£ã¦ã¿ãŸ \- BAKUNOTE](https://blog.bakunyo.com/2019/02/26/github-actions-git-pr-release/)

### [release\-drafter](https://github.com/release-drafter/release-drafter)

å‰ãƒªãƒªãƒ¼ã‚¹ã¨ã®å·®åˆ† PR æƒ…å ±ã‚’ body ã«è‡ªå‹•å…¥åŠ›ã—ã¦ release ã¨ã—ã¦å…¬é–‹ã—ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Draft PRã‚’ä½œæˆã—ã¾ã™ãŒã€master push æ™‚ã«ã—ã‹ä½¿ã‚ãªã„ã®ã§ã€è¨­å®šã§å…¬é–‹ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€PRã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯ä½¿ã£ã¦ã„ã¾ã›ã‚“ã€‚

### [actions/checkout](https://github.com/actions/checkout)

æŒ‡å®šã®ãƒªãƒã‚¸ãƒˆãƒªã‚„ãƒ–ãƒ©ãƒ³ãƒã« checkout ã—ã¾ã™ã€‚
ä»Šå›ã¯`main`ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ heroku ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã—ãŸã€‚

### [heroku\-deploy](https://github.com/AkhileshNS/heroku-deploy)

heroku ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ã£ã¦ã„ã¾ã™ã€‚


### [slack\-github\-action](https://github.com/slackapi/slack-github-action)

Slack é€šçŸ¥ã«ä½¿ã£ã¦ã„ã¾ã™ã€‚

`heroku-deploy`ã¨`slack-github-action`ã§ã¯ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ãªã®ã§ã€ãƒªãƒã‚¸ãƒˆãƒªã® Setting â†’ ã‚µã‚¤ãƒ‰ãƒãƒ¼ã® Secrets â†’ Actions ã‹ã‚‰ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

<img width="343" alt="image" src="https://user-images.githubusercontent.com/44717752/177827637-18130d01-cb3d-47b4-8da2-1f6439cae129.png">

<img width="822" alt="image" src="https://user-images.githubusercontent.com/44717752/177827827-ad6d224b-fcb3-4a35-9847-2aea5d65f33b.png">


## å®Ÿéš›ã®æŒ™å‹•

<img width="937" alt="image" src="https://user-images.githubusercontent.com/44717752/177830641-fdb99ccc-8d69-4669-848a-96baf96cf9a2.png">

<img width="1147" alt="image" src="https://user-images.githubusercontent.com/44717752/177831244-b173f8df-d2a9-4db3-829f-846d90f5a163.png">

<img width="700" alt="image" src="https://user-images.githubusercontent.com/44717752/177831160-633ea778-84aa-4ac2-9eae-52701382baf6.png">

<img width="565" alt="image" src="https://user-images.githubusercontent.com/44717752/177834140-4e5c8576-2895-47f8-b933-b671983fe006.png">


## å®Ÿéš›ã® yml

```yml:.github/workflows/git-pr-release.yml
name: Create PR to main

on:
  push:
    branches:
      - develop

jobs:
  git-pr-release:
    name: git-pr-release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: git-pr-release
        uses: bakunyo/git-pr-release-action@v1.4
        env:
          TZ: "Asia/Tokyo" # ã‚¿ã‚¤ãƒˆãƒ«ã®æ—¥æ™‚ã‚’ +9 ã«ã™ã‚‹ãŸã‚
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_PR_RELEASE_BRANCH_PRODUCTION: main
          GIT_PR_RELEASE_BRANCH_STAGING: develop
          GIT_PR_RELEASE_LABELS: release
          GIT_PR_RELEASE_TEMPLATE: .github/RELEASE_PULL_REQUEST_TEMPLATE.md
```

```yml:.github/workflows/release.yml
name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write # for release-drafter/release-drafter to create a github release
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main

      - name: heroku_deploy
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: hashlog # Must be unique in Heroku
          heroku_email: aiandrox7@gmail.com

      - name: Create Release
        id: create_release
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release-drafter.yml
          disable-autolabeler: true
          publish: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: echo release note
        id: get_release_note
        run: |
          # æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
          release_body='${{ steps.create_release.outputs.body }}'
          release_body=${release_body//$'\r\n'/\\n}
          release_body=${release_body//$'\n'/\\n}
          echo "::set-output name=body::$release_body"

      - name: Send Release Note
        uses: slackapi/slack-github-action@v1.19.0
        with:
          payload: |
            {
              "text": ":rocket: ${{ steps.create_release.outputs.published_at }} ${{ steps.create_release.outputs.name }} Released!\n${{ steps.create_release.outputs.html_url }}\n```${{ steps.get_release_note.outputs.body }}```",
              "unfurl_links": false
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # å¤±æ•—æ™‚ã® Slack é€šçŸ¥
  failure-notify:
    runs-on: ubuntu-latest
    needs: [release]
    if: failure()
    timeout-minutes: 5
    steps:
      - name: Send Failure
        uses: slackapi/slack-github-action@v1.19.0
        with:
          payload: |
            {
              "text": ":cry: Release Job Failure...\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

```yml:.github/release-drafter.yml
name-template: "v$RESOLVED_VERSION"
tag-template: "v$RESOLVED_VERSION"
exclude-labels:
  - "release"
categories:
  - title: "ğŸš€ Features"
    labels:
      - "feature"
      - "enhancement"
  - title: "ğŸ› Bug Fixes"
    labels:
      - "fix"
      - "bugfix"
      - "bug"
  - title: "ğŸ§° Maintenance"
    labels:
      - "chore"
  - title: "âš¡ Improvements"
    labels:
      - "refactoring"
  - title: "ğŸ“¦ Dependencies"
    labels:
      - "dependencies"
change-template: "- $TITLE @$AUTHOR (#$NUMBER)"
change-title-escapes: '\<*_&' # You can add # and @ to disable mentions, and add ` to disable code blocks.
version-resolver:
  major:
    labels:
      - "major"
  minor:
    labels:
      - "minor"
  patch:
    labels:
      - "patch"
  default: patch
template: |
  ## Changes

  $CHANGES
```

## å‚è€ƒ

- [GitHub ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã®ãƒ‰ãƒ©ãƒ•ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹ Release Drafter ã‚’å°å…¥ã™ã‚‹ \- kondoumh ã®ãƒ–ãƒ­ã‚°](https://blog.kondoumh.com/entry/2021/03/26/151425)
- [GitHub Actionsã§ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’SlackæŠ•ç¨¿ã™ã‚‹ \- Qiita](https://qiita.com/k-akie/items/95ce37b415ec681e1d79)
- [GitHub ActionsãŒå¤±æ•—ã—ãŸã‚‰Slackã«é€šçŸ¥ã™ã‚‹ with Slack Workflow \+ slack\-github\-action \- $shibayu36\->blog;](https://blog.shibayu36.org/entry/2022/01/24/170000)
- [Github Actionsã§ãƒªãƒªãƒ¼ã‚¹å¯¾è±¡ç¢ºèªã¨ãƒã‚§ãƒ³ã‚¸ãƒ­ã‚°ä½œæˆã®ä½œæ¥­ã‚’çœåŠ›åŒ–ã™ã‚‹ \| TSOne Tech Blog](https://www.tsone.co.jp/tech-blog/archives/1382)
- [GitHub Actionsã§1ã¤ä»¥ä¸Šã®ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ãŸå ´åˆã«Slackã«é€šçŸ¥ã™ã‚‹](https://zenn.dev/ntoy/articles/3e7521cd39a75b)
- [GitHub Actions Workflow ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ \| CyberAgent Developers Blog](https://developers.cyberagent.co.jp/blog/archives/36423)
- [GitHub Actions ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://zenn.dev/snowcait/scraps/9d9c47dc4d0414)
