---
title: "ã€ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆRuby on Railsã€5ç« "
date: 2020-09-04T18:26:30+09:00
lastmod: 2020-09-09
description: Active Job, Active Storage, Action Mailer, Action Mailbox, Action Text, Action Cable
draft: false
tags:
  - Ruby
  - Rails
  - ãƒ‘Rails
categories:
  - Ruby, Rails
  - æŠ€è¡“æ›¸
image: images/posts/2020/perfect_rails.png
series:
  - èª­æ›¸
---

# 5ç« 

## Active Jobã«ã‚ˆã‚‹éåŒæœŸå‡¦ç†

[Active Job ã®åŸºç¤ \- Railsã‚¬ã‚¤ãƒ‰](https://railsguides.jp/active_job_basics.html)

- ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹

ã®ã‚ˆã†ãªæ™‚é–“ãŒã‹ã‹ã‚‹å‡¦ç†ã§åˆ©ç”¨ã•ã‚Œã‚‹ã€‚

```sh
$ rails g job async_log
```

```rb:app/jobs/async_log_job.rb
class AsyncLogJob < ApplicationJob
  queue_as :default
  self.queue_adapter = :resque  # ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã§ãã‚‹

  def perform(*args)
    # Do something later
    p 'ã†ã‡ã„'
  end
end
```

ActiveJobã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`async`ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
Railsãƒ—ãƒ­ã‚»ã‚¹ä¸­ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«ã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚


```rb
irb(main):001:0> AsyncLogJob.perform_later
Enqueued AsyncLogJob (Job ID: 866b1eca-b425-4e7b-bc79-3131b9b7b95a) to Async(default)
Performing AsyncLogJob (Job ID: 866b1eca-b425-4e7b-bc79-3131b9b7b95a) from Async(default) enqueued at 2020-09-04T09:15:32Z
=> #<AsyncLogJob:0x00007fbf81b63170 @arguments=[], @job_id="866b1eca-b425-4e7b-bc79-3131b9b7b95a", @queue_name="default", @priority=nil, @executions=0, @exception_executions={}, @provider_job_id="ebb5736a-57fa-4890-97b2-8ba20c224947">
irb(main):002:0> "ã†ã‡ã„"
Performed AsyncLogJob (Job ID: 866b1eca-b425-4e7b-bc79-3131b9b7b95a) from Async(default) in 0.09ms
```

å¼•æ•°ã‚’æ¸¡ã™ã¨ãã¯`perform_later(hoge)`ã¨ã„ã†æ„Ÿã˜ã«æ¸¡ã™ã€‚
æ™‚é–“å·®ãŒã‚ã‚‹ã¨ãã¯`wait`ï¼ˆâ—‹ç§’ãƒ»åˆ†ãƒ»æ™‚é–“å¾Œï¼‰ã‚„`wait_until`ï¼ˆå®Ÿè¡Œæ™‚åˆ»ï¼‰ãªã©ã‚’ç”¨ã„ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã€‚

```rb
irb(main):005:0> AsyncLogJob.set(wait: 5.second).perform_later
Enqueued AsyncLogJob (Job ID: 11fb7339-b726-4534-9889-00f66087c037) to Async(default) at 2020-09-04 09:10:23 UTC
=> #<AsyncLogJob:0x00007fbf8163a658 @arguments=[], @job_id="1f94b1f8-9451-4fe6-84cc-46a3073a6069", @queue_name="default", @priority=nil, @executions=0, @exception_executions={}, @provider_job_id="6fc6a5e6-06bf-4a6e-b632-9c42cc14209d", @scheduled_at=1599210881.7301629>
irb(main):006:0> Performing AsyncLogJob (Job ID: 1f94b1f8-9451-4fe6-84cc-46a3073a6069) from Async(default) enqueued at 2020-09-04T09:14:36Z
"ã†ã‡ã„"
Performed AsyncLogJob (Job ID: 1f94b1f8-9451-4fe6-84cc-46a3073a6069) from Async(default) in 0.1ms
```

asyncã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚’å†èµ·å‹•ã™ã‚‹ã¨ã‚¸ãƒ§ãƒ–ãŒæ¶ˆãˆã‚‹ã€‚

è¤‡æ•°ã‚­ãƒ¥ãƒ¼ã‚’ä½¿ã†å ´åˆã€‚

- ç‰¹å®šã®ã‚¸ãƒ§ãƒ–ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‹
- é‡è¦åº¦ã«å¿œã˜ã¦ã‚­ãƒ¥ãƒ¼ã‚’ä½¿ã„åˆ†ã‘ã‚‹

### Active Jobã‚’ä½¿ã†ã‹ç›´æ¥åˆ©ç”¨ã™ã‚‹ã‹ï¼Ÿ

#### ActiveJobã‚’ä½¿ã†ã¨ã„ã„å ´åˆ

- æ¨™æº–çš„ãªæ©Ÿèƒ½ã®ã¿ä½¿ã†
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é¸æŠã‚’ã¾ã ã—ã¦ã„ãªã„
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å·®ã—æ›¿ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- Active Jobã«ä¾å­˜ã—ãŸæ©Ÿèƒ½ã‚’ä½¿ã†
  - Action Mailer
  - Action Mailbox
  - Active Storage
- Active Recordã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚­ãƒ¥ãƒ¼ã¸è¿½åŠ ã™ã‚‹ã¨ãã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹Global IDã‚’ä½¿ã£ãŸå¤‰æ›å‡¦ç†ã‚’åˆ©ç”¨ã™ã‚‹


#### éåŒæœŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ç›´æ¥ä½¿ã†ã¨ã„ã„å ´åˆ

- Active Jobã‹ã‚‰ã§ã¯ä½¿ãˆãªã„æ©Ÿèƒ½ãŒã‚ã‚‹
  - Sidekiqã§ã¯å¤–éƒ¨Gemï¼ˆSidekiq Pro, Sidekiq Enterpriseãªã©ï¼‰ã‚’ä½¿ã†ã¨ã


## Active Storage

```sh
$ rails active_storage:install
Copied migration 20200905070422_create_active_storage_tables.active_storage.rb from active_storage

$ rails g scaffold user name portrait:attachment
```

```rb:app/models/user.rb
class User < ApplicationRecord
  has_one_attached :portrait
end
```

```app/models/book.rb
class Book < ApplicationRecord
  has_many_attached :pictures
end
```

```rb:db/schema
ActiveRecord::Schema.define(version: 2020_09_05_071839) do

  create_table "active_storage_attachments", force: :cascade do |t|
    t.string "name", null: false
    t.string "record_type", null: false
    t.integer "record_id", null: false
    t.integer "blob_id", null: false
    t.datetime "created_at", null: false
    t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
    t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
  end

  create_table "active_storage_blobs", force: :cascade do |t|
    t.string "key", null: false
    t.string "filename", null: false
    t.string "content_type"
    t.text "metadata"
    t.bigint "byte_size", null: false
    t.string "checksum", null: false
    t.datetime "created_at", null: false
    t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
  end

  create_table "books", force: :cascade do |t|
    t.string "title"
    t.datetime "created_at", precision: 6, null: false
    t.datetime "updated_at", precision: 6, null: false
  end

  create_table "users", force: :cascade do |t|
    t.string "name"
    t.datetime "created_at", precision: 6, null: false
    t.datetime "updated_at", precision: 6, null: false
  end

  add_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id"
end
```

```rb
irb(main):002:0> user.portrait
=> #<ActiveStorage::Attached::One:0x00007fa3aabc5c50 @name="portrait", @record=#<User id: 1, name: "admin", created_at: "2020-09-05 09:01:31", updated_at: "2020-09-05 09:01:31">>
```

[ã€railsã€‘Active Storage \- Qiita](https://qiita.com/hiro266/items/99d977ae056875cbf99c)

User -< ActiveStorage::Attachment >- ActiveStorage::Blob
Post -<

ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯ãªã®ã§ã“ã‚“ãªæ„Ÿã˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã€‚

### ã‚µãƒ ãƒã‚¤ãƒ«

- Gemã«ã‚ˆã£ã¦ä½œæˆã™ã‚‹ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹ï¼‰
  - CarrierWaveï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
  - Shrineï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«éåŒæœŸã§ï¼‰
- ActiveStorageã®æ©Ÿèƒ½ï¼ˆç”»åƒURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«ç”Ÿæˆã•ã‚Œã‚‹ï¼‰
  - ImageProcessing
  - ImageMagick

```rb
<%= image_tag @user.portrait.variant(resize_to_limit: [100, 100]) %>
```

`variant`ãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã—ãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€‚ImageProcessingãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã‚Œã°ãã£ã¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ã€å­˜åœ¨ã—ã¦ã„ãªã‘ã‚Œã°ImageMagickã®ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
`@user.portrait.variant(resize_to_limit: [100, 100])`ã¨è¨˜è¿°ã—ãŸå ´åˆã€æˆ»ã‚Šå€¤ã¯Blobã®IDã¨å¤‰æ›å½¢å¼ã‚’å«ã‚“ã URLãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

```rb
irb(main):004:0> user.portrait.variant(resize_to_limit: [100, 100])
  ActiveStorage::Attachment Load (0.4ms)  SELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = ? AND "active_storage_attachments"."record_type" = ? AND "active_storage_attachments"."name" = ? LIMIT ?  [["record_id", 1], ["record_type", "User"], ["name", "portrait"], ["LIMIT", 1]]
  ActiveStorage::Blob Load (0.2ms)  SELECT "active_storage_blobs".* FROM "active_storage_blobs" WHERE "active_storage_blobs"."id" = ? LIMIT ?  [["id", 1], ["LIMIT", 1]]
=> #<ActiveStorage::Variant:0x00007fa3aaca0f58 @blob=#<ActiveStorage::Blob id: 1, key: "pf42amrmpitko8t7747cbfj8vsj0", filename: "tangchi-lee-jS_LsILp5hk-unsplash.jpg", content_type: "image/jpeg", metadata: {"identified"=>true, "analyzed"=>true}, byte_size: 304017, checksum: "1NwI5yh330iiI8K9LfhzqA==", created_at: "2020-09-05 09:01:31">, @variation=#<ActiveStorage::Variation:0x00007fa3aaca8ac8 @transformations={:resize_to_limit=>[100, 100]}>>
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™

ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒšãƒ¼ã‚¸ã«ã¯åˆ¶é™ã‚’ã‹ã‘ã¤ã¤ã€ç”»åƒãã®ã‚‚ã®ã«å¯¾ã™ã‚‹URLã«ã¯åˆ¶é™ã‚’ã‹ã‘ãªã„ã€‚
ActiveStorageã‚’åˆ©ç”¨ã—ãŸå ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®æœŸé™ä»˜ãURLã‚’ä½œæˆã—ã€ãã“ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ï¼ˆæœŸé™ã¯ãƒ‡ãƒ•ã‚©5åˆ†ï¼‰ã€‚

### ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

çœç•¥ã€‚

### Active STorageã®å•é¡Œç‚¹

- validationãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä¸è¶³
  - è‡ªå‰å®Ÿè£… or [Active Storage Validations](https://github.com/igorkasyanchuk/active_storage_validations)ãªã©ã®Gem
- cacheã®ä¸è¶³
  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã«ç”»åƒãŒæ¶ˆãˆã¦ã—ã¾ã†


## Action Mailer

[Action Mailer ã®åŸºç¤ \- Railsã‚¬ã‚¤ãƒ‰](https://railsguides.jp/action_mailer_basics.html)

```sh
$ rails g mailer UserMailer

Running via Spring preloader in process 73389
      create  app/mailers/user_mailer.rb
      invoke  erb
      create    app/views/user_mailer
      invoke  test_unit
      create    test/mailers/user_mailer_test.rb
      create    test/mailers/previews/user_mailer_preview.rb
```

```rb:app/mailers/user_mailer.rb
class UserMailer < ApplicationMailer
  def welcome
    @name = params[:name]
    mail(to: params[:to], subject: "ç™»éŒ²å®Œäº†")
  end
end
```

`params`ã§å€¤ã‚’å–å¾—ã™ã‚‹ã®ã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¨åŒã˜ã€‚
`UserMailer.with(to: "foo@example.com", name: "foo").welcome.deliver_now`ã§å®Ÿè¡Œã™ã‚‹ã€‚
ActiveJobã‚’ç”¨ã„ã¦éåŒæœŸã§é€ä¿¡ã™ã‚‹å ´åˆã¯`deliver_later`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

ãƒ¡ãƒ¼ãƒ«ã®æœ¬æ–‡ã¯`app/views/user_mailer/welcome.html.erb`, `app/views/user_mailer/welcome.text.erb`ã‚’ä½œæˆã—ã¦å®Ÿè£…ã™ã‚‹ã€‚
æ™®é€šã®Viewã¨åŒã˜ã€‚

### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½

ãƒ†ã‚¹ãƒˆã§welcomeãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹ã€‚

```rb:test/mailers/previews/user_mailer_preview.rb
# Preview all emails at http://localhost:3000/rails/mailers/user_mailer
class UserMailerPreview < ActionMailer::Preview
  def welcome
    UserMailer.with(to: "foo@example.com", name: "foo").welcome
  end
end
```

![ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼](/images/posts/2020/0905.png)


## Action Mailbox

ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã•ã‚ŒãŸã¨ãã«ä½•ã‹ã‚’ã™ã‚‹ã€ãªã©ã€‚
è‡ªå‹•é€ä¿¡ãƒ¡ãƒ¼ãƒ«ã¸ã®è¿”ä¿¡ãªã©ã§ä½¿ã‚ã‚Œã‚‹ã€‚

ActiveJobã¨ActiveStorageãŒå¿…è¦ã€‚

```sh
$ rails action_mailbox:install
Copying application_mailbox.rb to app/mailboxes
      create  app/mailboxes/application_mailbox.rb
Copied migration 20200905114414_create_action_mailbox_tables.action_mailbox.rb from action_mailbox

$ rails db:migrate
```

```rb:config/environments/production.rb
Rails.application.configure do
  # Prepare the ingress controller used to receive mail
  config.action_mailbox.ingress = :sendgrid
end
```

çœç•¥ã€‚

Sendgrid
â†’`https://actionmailbox:YOUR_PASSWORD@example.com/rails/action_mailbox/sendgrid/inbound_emails`
â†’`ApplicationMailbox`ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â†’`FooMailbox#process`

## Action Textã«ã‚ˆã‚‹ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆæ©Ÿèƒ½

- WYSIWYGã‚¨ãƒ‡ã‚£ã‚¿
- ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¿å­˜ã™ã‚‹ãƒ¢ãƒ‡ãƒ«
- ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šæ‰±ã†ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰

```sh
$ rails action_text:install
Copying actiontext.scss to app/assets/stylesheets
      create  app/assets/stylesheets/actiontext.scss
Copying fixtures to test/fixtures/action_text/rich_texts.yml
      create  test/fixtures/action_text/rich_texts.yml
Copying blob rendering partial to app/views/active_storage/blobs/_blob.html.erb
      create  app/views/active_storage/blobs/_blob.html.erb
Installing JavaScript dependencies
         run  yarn add trix@^1.2.0 @rails/actiontext@^6.0.3-2 from "."
yarn add v1.22.5
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
warning " > rails-erb-loader@5.5.2" has unmet peer dependency "webpack@^2.0.0 || >= 3.0.0-rc.0 || ^3.0.0".
warning " > webpack-dev-server@3.11.0" has unmet peer dependency "webpack@^4.0.0 || ^5.0.0".
warning "webpack-dev-server > webpack-dev-middleware@3.7.2" has unmet peer dependency "webpack@^4.0.0".
[4/4] ğŸ”¨  Building fresh packages...
success Saved lockfile.
success Saved 2 new dependencies.
info Direct dependencies
â”œâ”€ @rails/actiontext@6.0.3-2
â””â”€ trix@1.2.4
info All dependencies
â”œâ”€ @rails/actiontext@6.0.3-2
â””â”€ trix@1.2.4
âœ¨  Done in 13.18s.
Adding trix to app/javascript/packs/application.js
      append  app/javascript/packs/application.js
Adding @rails/actiontext to app/javascript/packs/application.js
      append  app/javascript/packs/application.js
Copied migration 20200905120646_create_action_text_tables.action_text.rb from action_text
```

```rb:app/models/user.rb
class User < ApplicationRecord
  has_rich_text :content  # è¿½åŠ ã™ã‚‹
  has_one_attached :portrait
end
```

```erb:app/views/users/_form.html.erb
<%= form_with(model: user, local: true) do |form| %>

  <!-- çœç•¥ -->

  <div class="field">
    <%= form.label :content %>
    <%= form.rich_text_area :content %>
  </div>

  <div class="actions">
    <%= form.submit %>
  </div>
<% end %>
```

![ãƒ•ã‚©ãƒ¼ãƒ ](/images/posts/2020/0905-2.png)

```rb
<%= @post.content %>
```

![è¡¨ç¤º](/images/posts/2020/0905-3.png)

### ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

`$ brew install imagemagick`

```rb:Gemfile..rb
...
# Use Active Storage variant
gem 'image_processing', '~> 1.2'
...
```

`image_processing`ã‚’bundle installã—ã¦ã„ãªãã¦ã‚‚ã§ããŸâ€¦â€¦ã‚ã‚Œï¼Ÿï¼Ÿ

### æ³¨æ„ç‚¹

- `post`ã¨`:content`ã¯ahs_manyãªã®ã§ã€N+1å•é¡Œã«æ°—ã‚’ã¤ã‘ã‚‹
  - eager_loadã—ã¦å‘¼ã³å‡ºã™ãƒ¡ã‚½ãƒƒãƒ‰
  `with_rich_text_#{name}`ã¨`with_rich_text_#{name}_and_embeds`

`@posts = Post.with_rich_text_content`

## Action Cable

WebSocketã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚

```sh
$ rails g channel room speak
Running via Spring preloader in process 79960
      invoke  test_unit
      create    test/channels/room_channel_test.rb
      create  app/channels/room_channel.rb
   identical  app/javascript/channels/index.js
   identical  app/javascript/channels/consumer.js
      create  app/javascript/channels/room_channel.js
```

`app/channels/room_channel.rb`ã¨`app/javascript/channels/room_channel.js`ãŒWebSocketå‡¦ç†ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚’å—ã‘æŒã¤ã€‚

```sh
$ rails s
...
Completed 200 OK in 127ms (Views: 114.7ms | ActiveRecord: 1.2ms | Allocations: 21609)

Started GET "/cable" for 127.0.0.1 at 2020-09-06 01:16:48 +0900
Started GET "/cable/" [WebSocket] for 127.0.0.1 at 2020-09-06 01:16:49 +0900
Successfully upgraded to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: Upgrade, HTTP_UPGRADE: websocket)
RoomChannel is transmitting the subscription confirmation
```

ã“ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚ŒãŸã‚‰WebSocketã§ã®æ¥ç¶šãŒã§ããŸã¨ã„ã†ã“ã¨ã€‚
ï¼ˆæ„å‘³ã¨ã—ã¦ã¯ã€/cableã«Rackã‚µãƒ¼ãƒãƒ¼ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã¦ã€WebSocketé€šä¿¡é–‹å§‹æ™‚ã«ãã“ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ï¼‰

```rb:app/channels/room_channel.rb
class RoomChannel < ApplicationCable::Channel
  def subscribed  # è³¼èª­å¾Œã«å‘¼ã°ã‚Œã‚‹
    stream_from "room_channel"  # ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆï¼ˆæ¥ç¶šã—ã¦ã„ã‚‹å…¨è³¼èª­è€…ã¸ã®é€ä¿¡ï¼‰ç”¨ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ åã‚’è¨­å®š
  end

  def unsubscribed  # è³¼èª­è§£é™¤å¾Œã«å‘¼ã°ã‚Œã‚‹
  end

  def speak(data)  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰å‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ãƒ¡ã‚½ãƒƒãƒ‰åã¯ä»»æ„
    # room_cannelã«æ¥ç¶šã—ã¦ã„ã‚‹äººå…¨å“¡ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
    ActionCable.server.broadcast("room_channel", { message: data["message"]})
  end
end
```

```js:app/javascript/channels/room_channel.js
import consumer from "./consumer";

consumer.subscriptions.create("RoomChannel", {
  connected() {
    // ãƒãƒ£ãƒãƒ«ã¨ã®æ¥ç¶šæ™‚
  },

  disconnected() {
    // ãƒãƒ£ãƒãƒ«ã¨ã®åˆ‡æ–­æ™‚
  },

  received(data) {
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸã¨ã
    alert(data["message"]+"ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
  },

  speak: function (message) {
    // RoomChannel#speakã‚’WebSocketçµŒç”±ã§å‘¼ã³å‡ºã™
    // thisã¯Subscription
    return this.perform("speak", { message: message});
  },
});
```

`window.App = consumer.subscriptions.create("RoomChannel", {...`ã¨å®šç¾©ã—ã¦ã€`App.speak("Hi!")`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ActionCableçµŒç”±ã§`received`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚

![Hi!](/images/posts/2020/0905-4.png)

### ãƒãƒ£ãƒƒãƒˆ

```html:app/views/messages/_message.html.erb..html
<div id="messages">
  <%= render @messages %>
</div>
<br>
<form>
  <label>Say something:</label>
  <input type="text" data-behavior="room_speaker">
</form>
```

```js:app/javascript/channels/room_channel.js
...
  connected() {
    // ãƒãƒ£ãƒãƒ«ã¨ã®æ¥ç¶šæ™‚
    document
      .querySelector('input[data-behavior="room_speaker"]')
      .addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
          this.speak(event.target.value);
          event.target.value = ""; // inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºã«ã™ã‚‹
          return event.preventDefault; // Enterã‚­ãƒ¼ã‚’æŠ¼ã™ã“ã¨ã«ã‚ˆã£ã¦ç”Ÿã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
        }
      });
  },

  received(data) {
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸã¨ã
    const element = document.querySelector("#messages");
    // div#messagesã®å†…éƒ¨ã®æœ€å¾Œã«div.messageï¼ˆéƒ¨åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ã‚’è¿½åŠ ã™ã‚‹
    element.insertAdjacentHTML("beforeend", data["message"]);
  },
...
```

```rb:app/channels/room_channel.rb
class RoomChannel < ApplicationCable::Channel
  ...

  def speak(data)
    message = Message.create!(content: data['message']) # é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹
    # messageãŒå…¥ã£ãŸéƒ¨åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆHTMLã‚’ãƒ•ãƒ­ãƒ³ãƒˆã«é€ä¿¡ã™ã‚‹
    ActionCable.server.broadcast("room_channel", { message: render_message(message) })
  end

  private

  def render_message(message)
    # éƒ¨åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆã—ãŸHTML
    ApplicationController.render(partial: 'messages/message', locals: { message: message })
  end
end
```

`ApplicationController.render`ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©å¤–ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
é€ä¿¡æ™‚ã®ãƒ­ã‚°ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```sh
RoomChannel#speak({"message"=>"ã¦ã™ã¨"})
   (0.1ms)  begin transaction
  â†³ app/channels/room_channel.rb:10:in `speak'
  Message Create (0.6ms)  INSERT INTO "messages" ("content", "created_at", "updated_at") VALUES (?, ?, ?)  [["content", "ã¦ã™ã¨"], ["created_at", "2020-09-06 05:38:21.300677"], ["updated_at", "2020-09-06 05:38:21.300677"]]
  â†³ app/channels/room_channel.rb:10:in `speak'
   (1.1ms)  commit transaction
  â†³ app/channels/room_channel.rb:10:in `speak'
  Rendered messages/_message.html.erb (Duration: 0.1ms | Allocations: 9)
[ActionCable] Broadcasting to room_channel: {:message=>"<div class=\"message\">\n  ã¦ã™ã¨\n</div>\n"}
RoomChannel transmitting {"message"=>"<div class=\"message\">\n  ã¦ã™ã¨\n</div>\n"} (via streamed from room_channel)
RoomChannel transmitting {"message"=>"<div class=\"message\">\n  ã¦ã™ã¨\n</div>\n"} (via streamed from room_channel)
```

![Image from Gyazo](https://i.gyazo.com/87c98700a5d92a28c15bf40ef0df2300.gif)

### æ³¨æ„ç‚¹ãªã©

ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯asyncã€æœ¬ç•ªç’°å¢ƒã§ã¯redisã‚’ä½¿ã†è¨­å®šã«ãªã£ã¦ã„ã‚‹ã€‚
`config/cable.yml`å‚ç…§

ãã®ä»–ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³æ§‹æˆã«ã™ã‚‹è¨­å®šã€WebSocketã®èªè¨¼èªå¯å‡¦ç†ã€ãƒ†ã‚¹ãƒˆã€‚çœç•¥ã€‚